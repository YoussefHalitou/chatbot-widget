<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Chatbot Widget</title>
  <style>
    /* Ensure the body has no margin or padding */
    body {
      margin: 0;
      padding: 0;
      background: transparent; /* Transparent background */
    }
  </style>
</head>
<body>
  <!-- Only the chatbot widget will be rendered here -->
  <script>
    (function() {
      // Create the widget container and attach it to the body.
      var widgetContainer = document.createElement('div');
      widgetContainer.id = "chatbot-widget-container";
      widgetContainer.style.position = "fixed";
      widgetContainer.style.bottom = "20px";
      widgetContainer.style.right = "20px";
      widgetContainer.style.zIndex = "9999";
      document.body.appendChild(widgetContainer);

      // Attach a Shadow DOM for style isolation.
      var shadow = widgetContainer.attachShadow({ mode: 'open' });

      // Define the HTML and CSS for the widget.
      var widgetHTML = `
        <style>
          /* Import Roboto font for modern typography */
          @import url('https://fonts.googleapis.com/css2?family=Roboto&display=swap');
          
          :host {
            font-family: 'Roboto', sans-serif;
          }

          /* Launcher Button with sophisticated gradient and pulse animation */
          #chat-launcher {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00B4DB, #0083B0, #003459);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 24px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease;
            animation: pulse 2s infinite;
          }
          #chat-launcher:hover {
            transform: scale(1.1);
          }
          @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
          }

          /* Chat Window Container */
          #chat-container {
            width: 380px;
            height: 520px;
            border-radius: 15px;
            background: #fff;
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            display: none;
            flex-direction: column;
            overflow: hidden;
            position: fixed;
            bottom: 90px;
            right: 20px;
            animation: slideUp 0.4s ease-out;
          }
          @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
          }

          /* Chat Header with multi-stop gradient and buttons */
          #chat-header {
            background: linear-gradient(135deg, #00B4DB, #0083B0, #003459);
            color: #fff;
            padding: 15px;
            text-align: center;
            font-size: 18px;
            font-weight: 500;
            position: relative;
          }
          /* Updated header text below (Piedies Helfer) */
          
          /* Clear Chat Button */
          #clear-button {
            position: absolute;
            top: 10px;
            right: 45px;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
          }
          /* Close Button */
          #close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
          }

          /* Chat Window for messages */
          #chat-window {
            flex: 1;
            background: #f5f5f5;
            padding: 15px;
            overflow-y: auto;
          }
          
          /* Message styling with avatars and fade-in animation */
          .message {
            display: flex;
            align-items: flex-start;
            margin: 8px 0;
            opacity: 0;
            animation: fadeIn 0.3s forwards;
          }
          /* Reverse alignment for user messages */
          .message.user-message {
            flex-direction: row-reverse;
          }
          /* Avatar styling */
          .avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #ccc;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 8px;
            font-size: 18px;
          }
          /* Container for message text and timestamp */
          .message-content {
            max-width: 70%;
            background: #e2e3e5;
            padding: 10px 15px;
            border-radius: 15px;
          }
          .message-text {
            font-size: 14px;
            color: #333;
          }
          .timestamp {
            font-size: 10px;
            color: #777;
            text-align: right;
            margin-top: 4px;
          }
          @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
          }

          /* Typing Indicator */
          .typing-indicator {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-radius: 20px;
            background: #e2e3e5;
            color: #41464b;
            max-width: 40%;
            animation: blink 1s infinite;
            margin: 8px 0;
          }
          @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
          }

          /* Input Container */
          #input-container {
            display: flex;
            border-top: 1px solid #ddd;
            padding: 10px;
            background: #fff;
          }
          #user-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
          }
          #send-button {
            margin-left: 10px;
            padding: 10px 15px;
            background: #007BFF;
            border: none;
            border-radius: 5px;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s ease;
          }
          #send-button:hover {
            background: #0056b3;
          }
        </style>

        <!-- Chat Launcher (visible initially) with updated text -->
        <div id="chat-launcher">ðŸ’¬</div>

        <!-- Chat Window (hidden initially) with updated header name -->
        <div id="chat-container">
          <div id="chat-header">
            Piedies Helfer
            <button id="clear-button">ðŸ—‘</button>
            <button id="close-button">&times;</button>
          </div>
          <div id="chat-window"></div>
          <div id="input-container">
            <input type="text" id="user-input" placeholder="Schreiben Sie hier Ihre Frage..." autofocus />
            <button id="send-button">Send</button>
          </div>
        </div>
      `;

      // Insert the HTML into the Shadow DOM.
      shadow.innerHTML = widgetHTML;

      // Retrieve elements from the Shadow DOM.
      var chatLauncher = shadow.getElementById('chat-launcher');
      var chatContainer = shadow.getElementById('chat-container');
      var closeButton = shadow.getElementById('close-button');
      var clearButton = shadow.getElementById('clear-button');
      var chatWindow = shadow.getElementById('chat-window');
      var userInput = shadow.getElementById('user-input');
      var sendButton = shadow.getElementById('send-button');

      // Function to add a message with an avatar and timestamp.
      function addMessage(text, sender) {
        var messageContainer = document.createElement('div');
        messageContainer.classList.add('message');
        if (sender === 'user') {
          messageContainer.classList.add('user-message');
        }

        var avatar = document.createElement('div');
        avatar.classList.add('avatar');
        avatar.textContent = sender === 'user' ? 'ðŸ‘¤' : 'ðŸ¤–';

        var content = document.createElement('div');
        content.classList.add('message-content');

        var textElem = document.createElement('div');
        textElem.classList.add('message-text');
        textElem.textContent = text;

        var timestamp = document.createElement('div');
        timestamp.classList.add('timestamp');
        var now = new Date();
        var hours = now.getHours().toString().padStart(2, '0');
        var minutes = now.getMinutes().toString().padStart(2, '0');
        timestamp.textContent = hours + ':' + minutes;

        content.appendChild(textElem);
        content.appendChild(timestamp);
        messageContainer.appendChild(avatar);
        messageContainer.appendChild(content);
        chatWindow.appendChild(messageContainer);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }

      // Functions to manage the typing indicator.
      var typingIndicator;
      function showTypingIndicator() {
        typingIndicator = document.createElement('div');
        typingIndicator.classList.add('typing-indicator');
        typingIndicator.textContent = 'Bot is typing...';
        chatWindow.appendChild(typingIndicator);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }
      function removeTypingIndicator() {
        if (typingIndicator) {
          chatWindow.removeChild(typingIndicator);
          typingIndicator = null;
        }
      }

      // Asynchronous function to send a message to your backend API.
      async function sendMessage(message) {
        addMessage(message, 'user');
        showTypingIndicator();

        var apiUrl = 'https://chatbotpiedi-561735337199.herokuapp.com/api/chat';
        try {
          var response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: message })
          });
          await new Promise(resolve => setTimeout(resolve, 1000));
          var data = await response.json();
          removeTypingIndicator();
          addMessage(data.message, 'bot');
        } catch (error) {
          console.error('Error:', error);
          removeTypingIndicator();
          addMessage('Sorry, something went wrong!', 'bot');
        }
      }

      // --- Event Listeners for Widget Interaction ---
      chatLauncher.addEventListener('click', function() {
        chatContainer.style.display = 'flex';
        chatLauncher.style.display = 'none';
        setTimeout(function() {
          userInput.focus();
        }, 100);
      });

      closeButton.addEventListener('click', function() {
        chatContainer.style.display = 'none';
        chatLauncher.style.display = 'flex';
      });

      clearButton.addEventListener('click', function() {
        chatWindow.innerHTML = '';
      });

      sendButton.addEventListener('click', function() {
        var message = userInput.value.trim();
        if (message !== '') {
          sendMessage(message);
          userInput.value = '';
        }
      });

      userInput.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
          var message = userInput.value.trim();
          if (message !== '') {
            sendMessage(message);
            userInput.value = '';
          }
        }
      });
    })();
  </script>
</body>
</html>